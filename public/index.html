<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chalo - Ride Sharing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <script>
        (function() {
            function applyTheme(theme) {
                if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
            const savedTheme = localStorage.getItem('theme') || 'system';
            applyTheme(savedTheme);
        })();
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* --- THEME COLORS (CSS VARIABLES) --- */
        :root {
            --color-bg-primary: #F9FAFB;
            --color-bg-secondary: #FFFFFF;
            --color-bg-tertiary: #F3F4F6;
            --color-text-primary: #1F2937;
            --color-text-secondary: #6B7280;
            --color-text-muted: #9CA3AF;
            --color-border: #E5E7EB;
        }

        html.dark {
            --color-bg-primary: #111827;
            --color-bg-secondary: #1F2937;
            --color-bg-tertiary: #374151;
            --color-text-primary: #F9FAFB;
            --color-text-secondary: #9CA3AF;
            --color-text-muted: #6B7280;
            --color-border: #4B5563;
        }

        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* View transition */
        .view { animation: fadeIn 0.5s ease-in-out; }
        
        /* Modal Transitions */
        .modal-backdrop { animation: fadeIn 0.3s ease-out; }
        .modal-content { animation: slideUp 0.4s ease-out; }

        /* Alert Notification */
        .alert-toast { animation: slideInDown 0.5s ease-out, fadeOut 0.5s ease-in 3.5s forwards; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideInDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Card hover effect */
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        html.dark .card-hover:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
        }
        
        /* Gradient background */
        .gradient-bg { background: linear-gradient(135deg, #3B82F6 0%, #10B981 100%); }
        
        /* Notification dot */
        .notification-dot {
            position: absolute; top: 2px; right: 2px; width: 10px; height: 10px;
            background-color: #EF4444; border-radius: 50%; border: 2px solid white;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        
        /* Location Suggestions Dropdown */
        .suggestions-container {
            position: absolute; width: 100%; background-color: var(--color-bg-secondary);
            border: 1px solid var(--color-border); border-top: none;
            border-radius: 0 0 0.5rem 0.5rem; z-index: 100; max-height: 200px;
            overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            opacity: 0; transform: translateY(-10px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out; pointer-events: none;
        }
        .suggestions-container.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .suggestion-item { padding: 0.75rem; cursor: pointer; transition: background-color 0.2s ease; }
        .suggestion-item:hover { background-color: var(--color-bg-tertiary); }

        /* Custom scrollbar */
        #chatMessages::-webkit-scrollbar { width: 6px; }
        #chatMessages::-webkit-scrollbar-track { background: transparent; }
        #chatMessages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        html.dark #chatMessages::-webkit-scrollbar-thumb { background: #555; }

        /* Focus ring */
        input:focus, button:focus-visible, a:focus-visible {
             outline: 2px solid transparent; outline-offset: 2px;
             box-shadow: 0 0 0 2px var(--color-bg-secondary), 0 0 0 4px #3B82F6;
        }

    </style>
    <script>
        // Tailwind CSS custom configuration
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6', 'primary-dark': '#2563EB',
                        secondary: '#10B981', accent: '#F59E0B',
                        dark: '#1F2937', light: '#F9FAFB'
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen">
    <nav class="bg-white/80 dark:bg-dark/80 backdrop-blur-lg shadow-md fixed w-full z-50 border-b border-transparent dark:border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="#" data-page="home" class="nav-link flex-shrink-0 flex items-center">
                        <div class="h-10 w-10 rounded-full gradient-bg flex items-center justify-center text-white font-bold text-xl">C</div>
                        <span class="ml-3 text-xl font-bold text-dark dark:text-light">Chalo</span>
                    </a>
                    <div id="main-nav-links" class="hidden md:ml-10 md:flex md:space-x-8">
                        <a href="#" data-page="home" class="nav-link text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary border-transparent border-b-2 hover:border-primary-dark px-1 pt-1 font-medium text-sm transition-colors duration-200">Home</a>
                        <a href="#" data-page="search" class="nav-link text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary border-transparent border-b-2 hover:border-primary-dark px-1 pt-1 font-medium text-sm transition-colors duration-200">Find Ride</a>
                        <a href="#" data-page="my-trips" class="nav-link text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary border-transparent border-b-2 hover:border-primary-dark px-1 pt-1 font-medium text-sm transition-colors duration-200">My Trips</a>
                        <a href="#" data-page="post-trip" class="nav-link text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary border-transparent border-b-2 hover:border-primary-dark px-1 pt-1 font-medium text-sm transition-colors duration-200">Offer Ride</a>
                    </div>
                </div>

                <div class="flex items-center">
                    <div class="hidden md:flex items-center space-x-4">
                        <div id="auth-buttons" class="flex space-x-2">
                            <button id="loginBtn" class="px-4 py-2 rounded-md text-sm text-primary border border-primary font-semibold hover:bg-primary hover:text-white transition-all duration-300">Log In</button>
                            <button id="signupBtn" class="px-4 py-2 rounded-md text-sm text-white bg-primary font-semibold hover:bg-primary-dark transition-all duration-300">Sign Up</button>
                        </div>
                        <div id="user-menu" class="flex items-center space-x-4">
                         <!-- Notifications Button -->
                        <button id="notificationsBtn" class="relative p-2 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary rounded-full transition-colors duration-200">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15h14a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
                            </svg>
                            <span id="notificationDot" class="notification-dot hidden"></span>
                        </button>

                        <!-- User Profile Dropdown -->
                        <div class="relative">
                            <button id="userButton" class="flex items-center space-x-2 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                                <!-- User Avatar -->
                                <div class="h-9 w-9 rounded-full bg-primary flex items-center justify-center text-white font-bold">
                                    <span id="userInitial">U</span>
                                </div>
                                <!-- User Name + Dropdown Arrow -->
                                <span id="userName" class="text-gray-700 dark:text-gray-300 text-sm font-medium hidden sm:block">User</span>
                                <svg class="w-4 h-4 text-gray-500 dark:text-gray-400 hidden sm:block" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>

                            <!-- Dropdown Menu -->
                            <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-[--color-bg-secondary] rounded-md shadow-lg py-1 hidden origin-top-right transition-all duration-200 ease-out transform opacity-0 scale-95 border border-[--color-border]">
                                <a href="#" data-page="profile" class="nav-link block px-4 py-2 text-sm text-[--color-text-primary] hover:bg-[--color-bg-tertiary]">Profile</a>
                                <a href="#" data-page="my-trips" class="nav-link block px-4 py-2 text-sm text-[--color-text-primary] hover:bg-[--color-bg-tertiary]">My Trips</a>
                                <a href="#" id="logoutBtn" class="block w-full text-left px-4 py-2 text-sm text-[--color-text-primary] hover:bg-[--color-bg-tertiary]">Logout</a>
                            </div>
                        </div>
                    </div>


                        <div id="theme-toggle-container" class="relative"></div>
                    </div>
                    
                    <div class="flex items-center md:hidden">
                        <div id="theme-toggle-container-mobile" class="relative"></div>
                        <button id="mobileMenuButton" class="p-2 rounded-md text-gray-500 dark:text-gray-400 hover:text-primary">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                    </div>
                </div>
                </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-[--color-bg-secondary] border-t border-[--color-border]"></div>
    </nav>

    <main class="pt-16 min-h-screen">
        <div id="homeView" class="view"></div>
        <div id="searchView" class="view hidden"></div>
        <div id="tripDetailsView" class="view hidden"></div>
        <div id="myTripsView" class="view hidden"></div>
        <div id="profileView" class="view hidden"></div>
        <div id="chatView" class="view hidden"></div>
    </main>

    <div id="loading-spinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
        <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-primary"></div>
    </div>
    <div id="alert-container" class="fixed top-5 left-1/2 -translate-x-1/2 w-full max-w-sm z-[100]"></div>
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden modal-backdrop p-4"></div>
    <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden modal-backdrop p-4"></div>
    <div id="postTripModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden modal-backdrop p-4"></div>
    <div id="manageRideModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden modal-backdrop overflow-y-auto p-4"></div>
    <div id="notificationsModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden modal-backdrop p-4"></div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // =======================================================================
    // || STATE & CONFIG                                                    ||
    // =======================================================================
    const state = {
        accessToken: localStorage.getItem('accessToken'), refreshToken: localStorage.getItem('refreshToken'),
        user: JSON.parse(localStorage.getItem('user')), socket: null, currentChatRequestId: null,
        currentPage: 'home', currentManagedTripId: null,
    };
    const API_URL = ''; // Backend is on the same origin
    const views = { home: document.getElementById('homeView'), search: document.getElementById('searchView'), 'trip-details': document.getElementById('tripDetailsView'), 'my-trips': document.getElementById('myTripsView'), profile: document.getElementById('profileView'), chat: document.getElementById('chatView'), };
    const modals = { login: document.getElementById('loginModal'), register: document.getElementById('registerModal'), 'post-trip': document.getElementById('postTripModal'), 'manage-ride': document.getElementById('manageRideModal'), notifications: document.getElementById('notificationsModal'), };

    // =======================================================================
    // || TEMPLATES FOR DYNAMIC CONTENT                                     ||
    // =======================================================================
    const Templates = {
        themeToggle: `
            <button id="theme-toggle-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary rounded-full transition-colors duration-200">
                <svg id="theme-icon-light" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.464A1 1 0 106.465 13.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 11a1 1 0 100-2H4a1 1 0 100 2h1zM4.54 5.46a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0z"></path></svg>
                <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
            </button>
            <div id="theme-dropdown" class="absolute right-0 mt-2 w-36 bg-[--color-bg-secondary] rounded-md shadow-lg py-1 hidden origin-top-right transition-all duration-200 ease-out transform opacity-0 scale-95 border border-[--color-border]">
                <a href="#" class="theme-select-btn block px-4 py-2 text-sm text-[--color-text-primary] hover:bg-[--color-bg-tertiary]" data-theme="light">Light</a>
                <a href="#" class="theme-select-btn block px-4 py-2 text-sm text-[--color-text-primary] hover:bg-[--color-bg-tertiary]" data-theme="dark">Dark</a>
                <a href="#" class="theme-select-btn block px-4 py-2 text-sm text-[--color-text-primary] hover:bg-[--color-bg-tertiary]" data-theme="system">System</a>
            </div>`,
        home: `<section class="gradient-bg text-white"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20 md:py-28 text-center md:text-left"><div class="flex flex-col md:flex-row items-center gap-12"><div class="md:w-1/2"><h1 class="text-4xl md:text-5xl font-extrabold mb-4 leading-tight">Ride Together, Save Together</h1><p class="text-lg md:text-xl text-blue-100 mb-8">Connect with drivers and passengers going your way. Affordable, convenient, and eco-friendly ridesharing.</p><div class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start"><button data-page="search" class="nav-link px-8 py-3 bg-white text-primary font-bold rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-300">Find a Ride</button><button data-page="post-trip" class="nav-link px-8 py-3 bg-accent text-white font-bold rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-300">Offer a Ride</button></div></div><div class="md:w-1/2 flex justify-center"><div class="relative w-full max-w-sm"><div class="relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 text-gray-800 dark:text-gray-200"><div class="flex justify-between items-center mb-6"><div><div class="text-lg font-bold">Mumbai to Pune</div><div class="text-sm text-gray-500 dark:text-gray-400">Today, 3:00 PM</div></div><div class="text-2xl font-bold text-primary">₹350</div></div><div class="flex items-center mb-6"><div class="flex flex-col items-center mr-4"><div class="w-3 h-3 bg-primary rounded-full"></div><div class="w-1 h-16 bg-gray-200 dark:bg-gray-700 my-1"></div><div class="w-3 h-3 bg-secondary rounded-full"></div></div><div><div class="font-medium">Bandra, Mumbai</div><div class="h-8"></div><div class="font-medium">Shivaji Nagar, Pune</div></div></div><div class="flex justify-between items-center"><div class="flex items-center"><div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold mr-3">R</div><div><div class="font-medium">Rahul Sharma</div><div class="text-sm text-gray-500 dark:text-gray-400">4.8 ★</div></div></div><div class="text-sm bg-gray-100 dark:bg-gray-700 dark:text-gray-300 px-3 py-1 rounded-full">4 seats left</div></div></div></div></div></div></div></section><section class="py-16 bg-white dark:bg-gray-900"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><h2 class="text-3xl font-bold text-center mb-12 text-gray-900 dark:text-white">How Chalo Works</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-8"><div class="text-center p-4"> <div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center text-white text-3xl font-bold mx-auto mb-6 shadow-lg">1</div><h3 class="text-xl font-semibold mb-3">Offer a Ride</h3><p class="text-gray-600 dark:text-gray-400">Drivers publish their trip details including route, timing, and fare.</p></div><div class="text-center p-4"><div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center text-white text-3xl font-bold mx-auto mb-6 shadow-lg">2</div><h3 class="text-xl font-semibold mb-3">Book a Seat</h3><p class="text-gray-600 dark:text-gray-400">Passengers find rides going their way and send booking requests.</p></div><div class="text-center p-4"><div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center text-white text-3xl font-bold mx-auto mb-6 shadow-lg">3</div><h3 class="text-xl font-semibold mb-3">Ride Together</h3><p class="text-gray-600 dark:text-gray-400">Connect, coordinate, and enjoy the journey while saving money and the planet.</p></div></div></div></section>`,
        search: `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h1 class="text-3xl font-bold mb-6">Find Your Ride</h1><div class="bg-[--color-bg-secondary] rounded-xl shadow-md p-6 mb-8 border border-[--color-border]"><form id="search-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end"><div class="relative"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">From</label><input type="text" name="origin" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg focus:border-primary focus:ring-primary location-input" placeholder="Enter origin" autocomplete="off"><div class="suggestions-container"></div></div><div class="relative"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">To</label><input type="text" name="destination" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg focus:border-primary focus:ring-primary location-input" placeholder="Enter destination" autocomplete="off"><div class="suggestions-container"></div></div><div><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Date</label><input type="date" name="departureDate" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg focus:border-primary focus:ring-primary"></div><button type="submit" class="w-full px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-primary-dark transition-colors duration-200">Search Rides</button></form></div><div id="trip-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>`,
        'my-trips': `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h1 class="text-3xl font-bold mb-6">My Trips</h1><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-[--color-bg-secondary] border border-[--color-border] rounded-xl shadow-md overflow-hidden"><div class="p-6 border-b border-[--color-border]"><h2 class="text-xl font-bold">Rides as Passenger</h2></div><div class="p-6 space-y-4" id="passenger-trips-list"><p class="text-[--color-text-secondary]">You haven't requested any rides.</p></div></div><div class="bg-[--color-bg-secondary] border border-[--color-border] rounded-xl shadow-md overflow-hidden"><div class="p-6 border-b border-[--color-border]"><h2 class="text-xl font-bold">Rides as Driver</h2></div><div class="p-6 space-y-4" id="driver-trips-list"><p class="text-[--color-text-secondary]">You haven't offered any rides.</p></div></div></div></div>`,
        profile: `<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h1 class="text-3xl font-bold mb-6">My Profile</h1><div id="profile-details" class="bg-[--color-bg-secondary] border border-[--color-border] rounded-xl shadow-md overflow-hidden mb-8"></div></div>`,
        chat: `<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 h-[calc(100vh-4rem)] flex flex-col"><div class="bg-[--color-bg-secondary] border border-[--color-border] rounded-xl shadow-md flex flex-col h-full"><div class="p-4 border-b border-[--color-border] flex items-center"><button data-page="my-trips" class="nav-link mr-3 text-[--color-text-secondary] hover:text-[--color-text-primary] p-2 rounded-full hover:bg-[--color-bg-tertiary] transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg></button><div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold mr-3" id="chatUserInitial"></div><div><h3 class="font-bold" id="chatUserName"></h3><p class="text-sm text-[--color-text-secondary]" id="chatTripRoute"></p></div></div><div class="flex-1 p-4 overflow-y-auto space-y-4" id="chatMessages"></div><form id="chat-form" class="p-4 border-t border-[--color-border] flex"><input type="text" id="chat-input" placeholder="Type your message..." class="flex-1 px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-l-lg focus:border-primary focus:ring-primary"><button type="submit" class="px-4 py-2 bg-primary text-white rounded-r-lg hover:bg-primary-dark transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg></button></form></div></div>`,
        loginModal: `<div class="bg-[--color-bg-secondary] rounded-xl shadow-2xl w-full max-w-md p-8 m-4 modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Log In</h2><button class="close-modal-btn text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-3xl font-light leading-none transition-colors">&times;</button></div><form id="login-form"><div class="mb-4"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Email</label><input type="email" id="login-email" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" required></div><div class="mb-6"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Password</label><input type="password" id="login-password" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" required></div><button type="submit" class="w-full py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary-dark transition-colors">Log In</button></form><p class="text-center mt-6 text-sm text-[--color-text-secondary]">Don't have an account? <a href="#" id="switchToRegisterBtn" class="font-semibold text-primary hover:underline">Sign Up</a></p></div>`,
        registerModal: `<div class="bg-[--color-bg-secondary] rounded-xl shadow-2xl w-full max-w-md p-8 m-4 modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Create Account</h2><button class="close-modal-btn text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-3xl font-light leading-none transition-colors">&times;</button></div><form id="register-form"><div class="mb-4"><input type="text" name="name" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" placeholder="Full Name" required></div><div class="mb-4"><input type="email" name="email" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" placeholder="Email" required></div><div class="mb-4"><input type="password" name="password" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" placeholder="Password" required></div><div class="mb-4"><input type="tel" name="phone" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" placeholder="Phone Number"></div><div class="mb-6"><label class="flex items-center"><input type="checkbox" name="is_driver" class="h-4 w-4 rounded text-primary focus:ring-primary"><span class="ml-2 text-sm text-[--color-text-primary]">I want to be a driver</span></label></div><button type="submit" class="w-full py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary-dark transition-colors">Create Account</button></form><p class="text-center mt-6 text-sm text-[--color-text-secondary]">Already have an account? <a href="#" id="switchToLoginBtn" class="font-semibold text-primary hover:underline">Log In</a></p></div>`,
        postTripModal: `<div class="bg-[--color-bg-secondary] rounded-xl shadow-2xl w-full max-w-lg p-8 m-4 modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Offer a Ride</h2><button class="close-modal-btn text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-3xl font-light leading-none transition-colors">&times;</button></div><form id="post-trip-form"><div class="grid md:grid-cols-2 gap-4 mb-4"><div class="relative"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">From</label><input type="text" name="origin" class="location-input w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" placeholder="Enter origin" required autocomplete="off"><div class="suggestions-container"></div></div><div class="relative"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">To</label><input type="text" name="destination" class="location-input w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" placeholder="Enter destination" required autocomplete="off"><div class="suggestions-container"></div></div></div><div class="grid md:grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Date</label><input type="date" name="departureDate" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" required></div><div><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Time</label><input type="time" name="departureTime" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" required></div></div><div class="grid md:grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Available Seats</label><input type="number" name="availableSeats" min="1" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" required></div><div><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Fare per seat (₹)</label><input type="number" name="suggestedFare" min="0" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg" required></div></div><div class="mb-4"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Vehicle Info</label><input type="text" name="vehicle_info" placeholder="e.g., Toyota Camry, White" class="w-full px-4 py-2 bg-[--color-bg-primary] border border-[--color-border] rounded-lg"></div><div class="grid grid-cols-3 gap-4 mb-6"><div><label class="flex items-center"><input type="checkbox" name="smoking_allowed" class="h-4 w-4 rounded text-primary"><span class="ml-2 text-sm text-[--color-text-primary]">Smoking</span></label></div><div><label class="flex items-center"><input type="checkbox" name="pets_allowed" class="h-4 w-4 rounded text-primary"><span class="ml-2 text-sm text-[--color-text-primary]">Pets</span></label></div><div><label class="flex items-center"><input type="checkbox" name="luggage_allowed" class="h-4 w-4 rounded text-primary" checked><span class="ml-2 text-sm text-[--color-text-primary]">Luggage</span></label></div></div><button type="submit" class="w-full py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary-dark transition-colors">Publish Ride</button></form></div>`,
        notificationsModal: `<div class="bg-[--color-bg-secondary] rounded-xl shadow-2xl w-full max-w-md p-6 m-4 modal-content"><div class="flex justify-between items-center mb-4 border-b border-[--color-border] pb-4"><h2 class="text-2xl font-bold">Notifications</h2><button class="close-modal-btn text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-3xl font-light leading-none transition-colors">&times;</button></div><div id="notifications-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div></div>`,
    };

    // =======================================================================
    // || API & CORE LOGIC (UNCHANGED)                                      ||
    // =======================================================================
    async function apiRequest(endpoint, method = 'GET', body = null) {
        showLoading(true);
        const headers = { 'Content-Type': 'application/json' };
        if (state.accessToken) headers['Authorization'] = `Bearer ${state.accessToken}`;
        const config = { method, headers, body: body ? JSON.stringify(body) : null };
        try {
            let response = await fetch(API_URL + endpoint, config);
            if (response.status === 401 && state.refreshToken) {
                if (await refreshAccessToken()) {
                    headers['Authorization'] = `Bearer ${state.accessToken}`;
                    response = await fetch(API_URL + endpoint, config);
                } else {
                    handleLogout();
                    showAlert('Session expired. Please log in again.');
                    return null;
                }
            }
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'An API error occurred');
            }
            return response.status === 204 ? true : await response.json();
        } catch (error) {
            showAlert(error.message);
            return null;
        } finally {
            showLoading(false);
        }
    }

    async function refreshAccessToken() {
        try {
            const res = await fetch(API_URL + '/api/refresh-token', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ refreshToken: state.refreshToken }) });
            if (!res.ok) return false;
            const data = await res.json();
            state.accessToken = data.accessToken;
            localStorage.setItem('accessToken', data.accessToken);
            return true;
        } catch (error) {
            return false;
        }
    }

    // =======================================================================
    // || VIEW & UI MANAGEMENT                                              ||
    // =======================================================================
    function showPage(pageId) {
        Object.values(views).forEach(v => v.classList.add('hidden'));
        if (views[pageId]) {
            views[pageId].classList.remove('hidden');
            views[pageId].innerHTML = Templates[pageId] || '';
        }
        state.currentPage = pageId;
        updateNavLinks(pageId);
        window.scrollTo(0, 0);
    }
    
    function showModal(modalId) {
        if (modals[modalId]) {
            const templateKey = modalId.replace(/-([a-z])/g, g => g[1].toUpperCase()) + 'Modal';
            modals[modalId].innerHTML = Templates[templateKey] || '';
            modals[modalId].classList.remove('hidden');
            setTimeout(() => { const firstInput = modals[modalId].querySelector('input'); if (firstInput) firstInput.focus(); }, 100);
            if (modalId === 'post-trip') {
                const dateInput = document.querySelector('#post-trip-form [name="departureDate"]');
                const timeInput = document.querySelector('#post-trip-form [name="departureTime"]');
                if (dateInput && timeInput) {
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset() + 60);
                    const today = new Date();
                    today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
                    dateInput.min = today.toISOString().split('T')[0];
                    dateInput.value = now.toISOString().split('T')[0];
                    timeInput.value = now.toISOString().substring(11, 16);
                }
            }
        }
    }

    function hideAllModals() {
        Object.values(modals).forEach(m => m.classList.add('hidden'));
    }

    function updateNavLinks(activePage) {
        document.querySelectorAll('.nav-link').forEach(link => {
            const isCurrentlyActive = link.classList.contains('text-primary');
            const shouldBeActive = link.dataset.page === activePage;
            if (isCurrentlyActive !== shouldBeActive) {
                link.classList.toggle('text-primary'); link.classList.toggle('border-primary');
                link.classList.toggle('text-gray-500'); link.classList.toggle('dark:text-gray-400'); link.classList.toggle('border-transparent');
            }
        });
    }

    function updateUIForAuthState() {
        const isAuthenticated = !!state.user;
        document.getElementById('auth-buttons').classList.toggle('hidden', isAuthenticated);
        document.getElementById('user-menu').classList.toggle('hidden', !isAuthenticated);
        document.querySelector('a[data-page="my-trips"]').parentElement.classList.toggle('hidden', !isAuthenticated);
        document.querySelector('a[data-page="post-trip"]').parentElement.classList.toggle('hidden', !isAuthenticated);
        const mobileMenuContainer = document.getElementById('mobile-menu');
        if (isAuthenticated) {
            mobileMenuContainer.innerHTML = `<div class="px-2 pt-2 pb-3 space-y-1"><a href="#" data-page="home" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Home</a><a href="#" data-page="search" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Find Ride</a><a href="#" data-page="my-trips" class="nav-link block px-3 py-2 rounded-md text-base font-medium">My Trips</a><a href="#" data-page="post-trip" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Offer Ride</a></div><div class="pt-4 pb-3 border-t border-[--color-border]"><div class="flex items-center px-5"><div class="h-10 w-10 rounded-full bg-primary flex items-center justify-center text-white font-bold"><span>${state.user.name.charAt(0)}</span></div><div class="ml-3"><div class="text-base font-medium text-[--color-text-primary]">${state.user.name}</div></div></div><div class="mt-3 px-2 space-y-1"><a href="#" data-page="profile" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Profile</a><a href="#" id="mobileLogoutBtn" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium">Logout</a></div></div>`;
        } else {
            mobileMenuContainer.innerHTML = `<div class="px-2 pt-2 pb-3 space-y-1"><a href="#" data-page="home" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Home</a><a href="#" data-page="search" class="nav-link block px-3 py-2 rounded-md text-base font-medium">Find Ride</a><hr class="my-2 border-[--color-border]"><button id="mobileLoginBtn" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium">Log In</button><button id="mobileSignupBtn" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium">Sign Up</button></div>`;
        }
        if (isAuthenticated) {
            document.getElementById('userInitial').textContent = state.user.name.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = state.user.name;
            connectSocket();
        }
        showPage('home');
    }

    function showLoading(isLoading) { document.getElementById('loading-spinner').classList.toggle('hidden', !isLoading); }
    
    function showAlert(message, isSuccess = false) {
        const container = document.getElementById('alert-container');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert-toast text-white p-4 rounded-lg shadow-lg mb-2 text-center ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
        alertDiv.textContent = message;
        container.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 4000);
    }
    
    // =======================================================================
    // || HTML RENDER FUNCTIONS                                             ||
    // =======================================================================
    function renderTripResults(trips) {
        const container = document.getElementById('trip-results');
        if (!container) return;
        if (!trips || trips.length === 0) {
            container.innerHTML = `<div class="text-center py-12 md:col-span-3"><h3 class="text-xl font-medium text-[--color-text-secondary]">No rides found</h3><p class="text-[--color-text-muted]">Try adjusting your search criteria</p></div>`;
            return;
        }
        container.innerHTML = trips.map(trip => {
            const seatsLeft = trip.available_seats - trip.booked_seats;
            return `<div class="bg-[--color-bg-secondary] border border-[--color-border] rounded-xl shadow-md overflow-hidden card-hover flex flex-col"><div class="p-6 flex-grow"><div class="flex justify-between items-start mb-4"><div><h3 class="text-xl font-bold">${trip.origin} &rarr; ${trip.destination}</h3><p class="text-[--color-text-secondary] text-sm">${formatDate(trip.departure_date)} &bull; ${formatTime(trip.departure_time)}</p></div><div class="text-2xl font-bold text-primary">₹${trip.suggested_fare}</div></div><div class="flex justify-between items-center mt-4"><div class="flex items-center"><div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold mr-3">${trip.driver_name.charAt(0)}</div><div><div class="font-medium">${trip.driver_name}</div><div class="text-sm text-[--color-text-secondary]">★ ${trip.driver_rating || 'N/A'}</div></div></div><div class="text-sm font-semibold ${seatsLeft > 0 ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'} px-3 py-1 rounded-full">${seatsLeft} seats left</div></div></div><div class="px-6 pb-6 mt-auto"><button data-trip-id="${trip.id}" class="view-details-btn w-full py-2 bg-primary text-white font-medium rounded-lg hover:bg-primary-dark transition-colors">Request Ride</button></div></div>`;
        }).join('');
    }

    function renderMyTrips(data) {
        const passengerContainer = document.getElementById('passenger-trips-list');
        const driverContainer = document.getElementById('driver-trips-list');
        if (!passengerContainer || !driverContainer) return;
        const statusClass = (status) => ({'pending':'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300','accepted':'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300','active':'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300','declined':'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300','completed':'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300'}[status] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300');
        if (!data.booked || data.booked.length === 0) passengerContainer.innerHTML = `<p class="text-[--color-text-secondary]">You haven't requested any rides.</p>`;
        else passengerContainer.innerHTML = data.booked.map(req => `<div class="bg-[--color-bg-tertiary] rounded-lg p-4 border border-[--color-border]"><div class="flex justify-between items-start mb-2"><div><h3 class="font-bold">${req.origin} &rarr; ${req.destination}</h3><p class="text-sm text-[--color-text-secondary]">${formatDate(req.departure_date)}</p></div><span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass(req.request_status)}">${req.request_status.charAt(0).toUpperCase() + req.request_status.slice(1)}</span></div><div class="flex justify-end gap-4 mt-2">${req.request_status !== 'pending' ? `<button class="view-details-btn text-sm text-primary hover:underline font-semibold" data-request-id="${req.request_id}">View Details</button>` : ''}${req.request_status === 'accepted' ? `<button class="chat-btn text-sm text-primary hover:underline font-semibold" data-request-id="${req.request_id}">Chat</button>` : ''}</div></div>`).join('');
        if (!data.offered || data.offered.length === 0) driverContainer.innerHTML = `<p class="text-[--color-text-secondary]">You haven't offered any rides.</p>`;
        else driverContainer.innerHTML = data.offered.map(trip => `<div class="bg-[--color-bg-tertiary] rounded-lg p-4 border border-[--color-border]"><div class="flex justify-between items-start mb-2"><div><h3 class="font-bold">${trip.origin} &rarr; ${trip.destination}</h3><p class="text-sm text-[--color-text-secondary]">${formatDate(trip.departure_date)}</p></div><span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass(trip.status)}">${trip.status.charAt(0).toUpperCase() + trip.status.slice(1)}</span></div><div class="flex justify-end mt-2"><button class="manage-ride-btn text-sm text-primary hover:underline font-semibold" data-trip-id="${trip.id}">Manage Ride</button></div></div>`).join('');
    }

    function renderProfile(profile) {
        const container = document.getElementById('profile-details');
        if (!container) return;
        container.innerHTML = `<div class="p-6"><div class="flex items-center mb-6"><div class="w-20 h-20 rounded-full bg-primary flex items-center justify-center text-white text-3xl font-bold mr-6">${profile.name.charAt(0)}</div><div><h3 class="text-2xl font-bold">${profile.name}</h3><p class="text-[--color-text-secondary]">${profile.email}</p></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-[--color-bg-tertiary] p-4 rounded-lg"> <label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Phone Number</label><p class="font-semibold">${profile.phone || 'N/A'}</p></div><div class="bg-[--color-bg-tertiary] p-4 rounded-lg"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Account Type</label><p class="font-semibold">${profile.is_driver ? 'Driver & Passenger' : 'Passenger'}</p></div><div class="bg-[--color-bg-tertiary] p-4 rounded-lg"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Rating</label><p class="font-semibold">★ ${profile.rating || 'N/A'} (${profile.total_ratings} ratings)</p></div><div class="bg-[--color-bg-tertiary] p-4 rounded-lg"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Total Trips</label><p class="font-semibold">${profile.total_trips || 0} trips</p></div></div></div>`;
    }

    function renderRideDetails(details) {
        const container = views['trip-details'];
        if (!container) return;
        const isDriver = state.user.id === details.driver_id;
        const otherPartyName = isDriver ? details.passenger_name : details.driver_name;
        const otherPartyRating = isDriver ? details.passenger_rating : details.driver_rating;
        container.innerHTML = `<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><button data-page="my-trips" class="nav-link flex items-center text-primary mb-6 hover:text-primary-dark font-semibold">&larr; Back to My Trips</button><div class="bg-[--color-bg-secondary] border border-[--color-border] rounded-xl shadow-md overflow-hidden"><div class="p-6 border-b border-[--color-border]"><div class="flex flex-col sm:flex-row justify-between items-start gap-4"><div><h1 class="text-2xl font-bold">${details.origin} &rarr; ${details.destination}</h1><p class="text-[--color-text-secondary]">${formatDate(details.departure_date)} &bull; ${formatTime(details.departure_time)}</p></div><div class="bg-[--color-bg-tertiary] h-24 w-full sm:w-32 rounded-lg"></div></div></div><div class="p-6"><h2 class="text-xl font-bold mb-4">${isDriver ? 'Passenger Details' : 'Driver & Ride Details'}</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-[--color-bg-tertiary] p-4 rounded-lg"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Name</label><p class="font-semibold">${otherPartyName}</p></div><div class="bg-[--color-bg-tertiary] p-4 rounded-lg"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Rating</label><p class="font-semibold">★ ${otherPartyRating || 'N/A'}</p></div>${!isDriver ? `<div class="bg-[--color-bg-tertiary] p-4 rounded-lg"><label class="block text-sm font-medium text-[--color-text-secondary] mb-1">Vehicle</label><p class="font-semibold">${details.vehicle_info || 'Not specified'}</p></div>` : ''}</div><div class="mt-6"><button class="chat-btn w-full py-3 bg-primary text-white font-medium rounded-lg" data-request-id="${details.id}">Chat with ${otherPartyName}</button></div></div></div></div>`;
    }

    function renderManageRide(data) {
        const container = modals['manage-ride'];
        if (!container) return;
        const { tripDetails, pendingRequests, acceptedPassengers } = data;
        let html = `<div class="bg-[--color-bg-secondary] rounded-xl shadow-2xl w-full max-w-2xl p-6 m-4 modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Manage Ride</h2><button class="close-modal-btn text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-3xl font-light leading-none transition-colors">&times;</button></div>`;
        html += `<div class="bg-[--color-bg-tertiary] p-4 rounded-lg space-y-2 border border-[--color-border] mb-6"><p class="text-lg font-bold">${tripDetails.origin} &rarr; ${tripDetails.destination}</p><div class="mt-2 flex gap-4">${tripDetails.status === 'active' ? `<button class="start-trip-btn bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-600 transition-colors" data-trip-id="${tripDetails.id}">Start Trip</button>` : ''}${tripDetails.status === 'started' ? `<button class="complete-trip-btn bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-600 transition-colors" data-trip-id="${tripDetails.id}">Complete Trip</button>` : ''}</div></div>`;
        html += `<h3 class="text-lg font-bold mb-4">Accepted Passengers (${acceptedPassengers.length})</h3>`;
        html += (!acceptedPassengers || acceptedPassengers.length === 0) ? `<p class="text-[--color-text-secondary] text-sm mb-6">No passengers accepted yet.</p>` : `<div class="space-y-2 mb-6">${acceptedPassengers.map(pax => `<div class="border border-[--color-border] rounded-lg p-3 flex justify-between items-center bg-[--color-bg-secondary]"><div><p><strong>${pax.passenger_name}</strong> (★ ${pax.rating || 'N/A'})</p><p class="text-sm text-[--color-text-secondary]">${pax.requested_seats} seat(s)</p></div><button class="chat-btn bg-purple-500 text-white px-3 py-1 rounded-md text-sm hover:bg-purple-600 transition-colors" data-request-id="${pax.id}">Chat</button></div>`).join('')}</div>`;
        html += `<h3 class="text-lg font-bold mb-4">Pending Requests (${pendingRequests.length})</h3>`;
        html += (!pendingRequests || pendingRequests.length === 0) ? `<p class="text-[--color-text-secondary] text-sm">No pending requests.</p>` : `<div class="space-y-2">${pendingRequests.map(req => `<div class="border border-[--color-border] rounded-lg p-3 flex justify-between items-center bg-[--color-bg-secondary]"><div><p><strong>${req.passenger_name}</strong> (★ ${req.rating || 'N/A'})</p><p class="text-sm text-[--color-text-secondary]">${req.requested_seats} seat(s)</p></div><div class="space-x-2"><button class="accept-request-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600 transition-colors" data-request-id="${req.id}">Accept</button><button class="decline-request-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition-colors" data-request-id="${req.id}">Decline</button></div></div>`).join('')}</div>`;
        html += `</div>`;
        container.innerHTML = html; container.classList.remove('hidden');
    }

    function renderChatMessages(messages) {
        const container = document.getElementById('chatMessages');
        if (!container) return;
        container.innerHTML = messages.map(msg => `<div class="flex ${msg.sender_id === state.user.id ? 'justify-end' : 'justify-start'}"><div class="rounded-lg p-3 max-w-[80%] ${msg.sender_id === state.user.id ? 'bg-primary text-white' : 'bg-[--color-bg-tertiary]'}"><p class="break-words">${msg.message}</p></div></div>`).join('');
        container.scrollTop = container.scrollHeight;
    }

    function renderNotifications(notifications) {
        const container = document.getElementById('notifications-list');
        if (!container) return;
        if (!notifications || notifications.length === 0) {
            container.innerHTML = `<div class="text-center py-8 text-[--color-text-secondary]"><p>No new notifications</p></div>`; return;
        }
        container.innerHTML = notifications.map(n => `<div class="flex items-start p-3 rounded-lg hover:bg-[--color-bg-tertiary] transition-colors"><div class="w-2 h-2 rounded-full bg-primary mt-1.5 mr-3 flex-shrink-0 ${n.is_read ? 'opacity-0' : ''}"></div><div class="flex-grow"><p class="font-semibold">${n.title}</p><p class="text-sm text-[--color-text-secondary]">${n.message}</p><p class="text-xs text-[--color-text-muted] mt-1">${timeAgo(n.created_at)}</p></div></div>`).join('');
    }

    // =======================================================================
    // || EVENT HANDLERS (UNCHANGED CORE LOGIC)                             ||
    // =======================================================================
    async function handleLogin(e) { e.preventDefault(); const data = await apiRequest('/api/login', 'POST', { email: e.target.elements['login-email'].value, password: e.target.elements['login-password'].value }); if (data) { Object.assign(state, { accessToken: data.accessToken, refreshToken: data.refreshToken, user: data.user }); localStorage.setItem('accessToken', data.accessToken); localStorage.setItem('refreshToken', data.refreshToken); localStorage.setItem('user', JSON.stringify(data.user)); showAlert('Login successful!', true); hideAllModals(); updateUIForAuthState(); } }
    async function handleRegister(e) { e.preventDefault(); const formData = new FormData(e.target); const body = Object.fromEntries(formData.entries()); body.is_driver = e.target.elements.is_driver.checked; const data = await apiRequest('/api/register', 'POST', body); if (data) { showAlert(data.message, true); hideAllModals(); showModal('login'); } }
    function handleLogout() { localStorage.clear(); Object.assign(state, { accessToken: null, refreshToken: null, user: null }); if (state.socket) state.socket.disconnect(); state.socket = null; updateUIForAuthState(); }
    async function loadAllTrips() { const today = new Date().toISOString().split('T')[0]; const dateInput = document.querySelector('#search-form [name="departureDate"]'); if (dateInput) dateInput.value = today; const data = await apiRequest(`/api/trips/search?departureDate=${today}`); if (data) renderTripResults(data.trips); }
    async function handleSearch(e) { e.preventDefault(); const params = new URLSearchParams(new FormData(e.target)); const data = await apiRequest(`/api/trips/search?${params.toString()}`); if (data) renderTripResults(data.trips); }
    async function handlePostTrip(e) { e.preventDefault(); const formData = new FormData(e.target); const body = Object.fromEntries(formData.entries()); body.smoking_allowed = e.target.elements.smoking_allowed.checked; body.pets_allowed = e.target.elements.pets_allowed.checked; body.luggage_allowed = e.target.elements.luggage_allowed.checked; const result = await apiRequest('/api/trips', 'POST', body); if (result) { showAlert('Ride published successfully!', true); hideAllModals(); showPage('my-trips'); loadMyTripsData(); } }
    async function loadMyTripsData() { const [offered, booked] = await Promise.all([apiRequest('/api/my-trips?role=driver'), apiRequest('/api/my-trips?role=passenger')]); renderMyTrips({ offered: offered?.trips, booked: booked?.trips }); }
    async function loadProfileData() { const data = await apiRequest('/api/profile'); if (data) renderProfile(data); }
    async function handleRequestRide(tripId) { if (!state.user) { showAlert("Please log in to request a ride."); showModal('login'); return; } const seats = prompt("How many seats?", "1"); if (seats && !isNaN(parseInt(seats)) && parseInt(seats) > 0) { const result = await apiRequest('/api/ride-requests', 'POST', { tripId: parseInt(tripId), requestedSeats: parseInt(seats) }); if (result) { showAlert('Ride request sent!', true); showPage('my-trips'); loadMyTripsData(); } } else if (seats !== null) { showAlert("Please enter a valid number of seats."); } }
    async function handleRequestStatusUpdate(requestId, status) { const result = await apiRequest(`/api/ride-requests/${requestId}/status`, 'PUT', { status }); if (result) { showAlert(`Request ${status}!`, true); handleManageRide(state.currentManagedTripId); } }
    async function handleTripStatusUpdate(tripId, status) { const result = await apiRequest(`/api/trips/${tripId}/${status}`, 'PUT'); if (result) { showAlert(`Trip ${status} successfully!`, true); if (status === 'complete') { hideAllModals(); loadMyTripsData(); } else { handleManageRide(tripId); } } }
    async function openChat(requestId) { state.currentChatRequestId = requestId; showPage('chat'); const [chatData, rideDetails] = await Promise.all([apiRequest(`/api/chat/${requestId}`), apiRequest(`/api/ride-requests/${requestId}`)]); if (chatData && rideDetails) { const isDriver = state.user.id === rideDetails.driver_id; const otherPartyName = isDriver ? rideDetails.passenger_name : rideDetails.driver_name; document.getElementById('chatUserName').textContent = otherPartyName; document.getElementById('chatUserInitial').textContent = otherPartyName.charAt(0); document.getElementById('chatTripRoute').textContent = `${rideDetails.origin} to ${rideDetails.destination}`; renderChatMessages(chatData.messages); if(state.socket) state.socket.emit('join_chat', requestId); } }
    async function handleSendMessage(e) { e.preventDefault(); const input = e.target.elements['chat-input']; const message = input.value.trim(); if (message && state.socket) { state.socket.emit('send_message', { requestId: state.currentChatRequestId, message }); input.value = ''; } }
    async function handleViewDetails(requestId) { showPage('trip-details'); const data = await apiRequest(`/api/ride-requests/${requestId}`); if (data) renderRideDetails(data); }
    async function handleManageRide(tripId) { state.currentManagedTripId = tripId; const data = await apiRequest(`/api/trips/${tripId}/management`); if (data) renderManageRide(data); }
    async function handleNotifications() { showModal('notifications'); const data = await apiRequest('/api/notifications'); if (data) { renderNotifications(data.notifications); await apiRequest('/api/notifications/read', 'PUT'); document.getElementById('notificationDot')?.classList.add('hidden'); } }

    // =======================================================================
    // || THEME MANAGEMENT                                                  ||
    // =======================================================================
    function setupTheme() {
        const themeToggleContainer = document.getElementById('theme-toggle-container');
        const themeToggleContainerMobile = document.getElementById('theme-toggle-container-mobile');
        themeToggleContainer.innerHTML = Templates.themeToggle;
        themeToggleContainerMobile.innerHTML = Templates.themeToggle;

        const lightIcon = document.querySelectorAll('#theme-icon-light');
        const darkIcon = document.querySelectorAll('#theme-icon-dark');
        
        function updateIcon(theme) {
            const isDark = theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            lightIcon.forEach(i => i.classList.toggle('hidden', isDark));
            darkIcon.forEach(i => i.classList.toggle('hidden', !isDark));
        }

        function applyTheme(theme) {
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('theme', theme);
            updateIcon(theme);
        }

        document.body.addEventListener('click', e => {
            const themeBtn = e.target.closest('#theme-toggle-btn');
            const themeSelect = e.target.closest('.theme-select-btn');
            
            if (themeBtn) {
                const dropdown = themeBtn.nextElementSibling;
                dropdown.classList.toggle('hidden');
                setTimeout(() => dropdown.classList.toggle('opacity-0'), 10);
                setTimeout(() => dropdown.classList.toggle('scale-95'), 10);
            } else if (themeSelect) {
                e.preventDefault();
                applyTheme(themeSelect.dataset.theme);
                const dropdown = themeSelect.parentElement;
                dropdown.classList.add('hidden', 'opacity-0', 'scale-95');
            } else if (!e.target.closest('#theme-toggle-container') && !e.target.closest('#theme-toggle-container-mobile')) {
                document.querySelectorAll('#theme-dropdown').forEach(d => d.classList.add('hidden', 'opacity-0', 'scale-95'));
            }
        });

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (localStorage.getItem('theme') === 'system') {
                applyTheme('system');
            }
        });
        
        applyTheme(localStorage.getItem('theme') || 'system');
    }

    // =======================================================================
    // || REAL-TIME & HELPERS (UNCHANGED CORE LOGIC)                        ||
    // =======================================================================
    function connectSocket() {
        if (state.socket || !state.accessToken) return;
        state.socket = io(window.location.origin, { auth: { token: state.accessToken } });
        state.socket.on('connect', () => {});
        state.socket.on('new_notification', (notification) => {
            showAlert(`${notification.title}`, true);
            document.getElementById('notificationDot')?.classList.remove('hidden');
            if (state.currentPage === 'my-trips') loadMyTripsData();
            if (modals['manage-ride'] && !modals['manage-ride'].classList.contains('hidden')) { handleManageRide(state.currentManagedTripId); }
        });
        state.socket.on('new_message', (message) => {
            if (state.currentPage === 'chat' && message.request_id === state.currentChatRequestId) {
                const container = document.getElementById('chatMessages');
                const msgDiv = document.createElement('div');
                msgDiv.className = `flex ${message.sender_id === state.user.id ? 'justify-end' : 'justify-start'}`;
                msgDiv.innerHTML = `<div class="rounded-lg p-3 max-w-[80%] ${message.sender_id === state.user.id ? 'bg-primary text-white' : 'bg-[--color-bg-tertiary]'}"><p class="break-words">${message.message}</p></div>`;
                container.appendChild(msgDiv); container.scrollTop = container.scrollHeight;
            } else {
                showAlert(`New message received!`, true);
                document.getElementById('notificationDot')?.classList.remove('hidden');
            }
        });
    }

    let debounceTimer;
    async function handleLocationInput(e) { const input = e.target; const query = input.value; const suggestionsContainer = input.nextElementSibling; if (query.length < 3) { suggestionsContainer.classList.remove('visible'); return; } clearTimeout(debounceTimer); debounceTimer = setTimeout(async () => { try { const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&countrycodes=in`); const suggestions = await response.json(); suggestionsContainer.innerHTML = suggestions.map(s => `<div class="suggestion-item" data-value="${s.display_name}">${s.display_name}</div>`).join(''); suggestionsContainer.classList.add('visible'); } catch (error) { console.error("Location fetch failed:", error); } }, 300); }
    function formatDate(dateString) { return new Date(dateString + 'T00:00:00').toLocaleDateString('en-IN', { weekday: 'short', month: 'short', day: 'numeric' }); }
    function formatTime(timeString) { if (!timeString) return ''; const [hours, minutes] = timeString.split(':'); const date = new Date(); date.setHours(hours, minutes); return date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true }); }
    function timeAgo(dateString) { const now = new Date(); const past = new Date(dateString); const seconds = Math.floor((now - past) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago"; return "Just now"; }

    // =======================================================================
    // || INITIALIZATION & EVENT LISTENERS                                  ||
    // =======================================================================
    function setupEventListeners() {
        document.body.addEventListener('submit', e => { e.preventDefault(); const formId = e.target.id; if (formId === 'login-form') handleLogin(e); if (formId === 'register-form') handleRegister(e); if (formId === 'search-form') handleSearch(e); if (formId === 'post-trip-form') handlePostTrip(e); if (formId === 'chat-form') handleSendMessage(e); });
        document.body.addEventListener('click', e => {
            const target = e.target; const navLink = target.closest('.nav-link'); const suggestionItem = target.closest('.suggestion-item');
            if (!suggestionItem && !target.closest('.location-input')) { document.querySelectorAll('.suggestions-container').forEach(c => c.classList.remove('visible')); }
            if (!target.closest('#userButton') && !target.closest('#userDropdown')) { const dropdown = document.getElementById('userDropdown'); dropdown.classList.add('opacity-0', 'scale-95'); setTimeout(() => dropdown.classList.add('hidden'), 200); }
            if (navLink) { e.preventDefault(); const pageId = navLink.dataset.page; document.getElementById('mobile-menu').classList.add('hidden'); const protectedPages = ['my-trips', 'profile', 'post-trip']; if (protectedPages.includes(pageId) && !state.user) { showAlert("Please log in to continue."); showModal('login'); return; } if (pageId === 'post-trip') { if (!state.user.is_driver) { showAlert("You must be a registered driver to offer rides."); return; } showModal('post-trip'); } else { showPage(pageId); } if (pageId === 'search') loadAllTrips(); if (pageId === 'my-trips') loadMyTripsData(); if (pageId === 'profile') loadProfileData(); }
            if (target.id === 'loginBtn' || target.id === 'mobileLoginBtn') showModal('login');
            if (target.id === 'signupBtn' || target.id === 'mobileSignupBtn') showModal('register');
            if (target.id === 'logoutBtn' || target.id === 'mobileLogoutBtn') handleLogout();
            if (target.id === 'switchToRegisterBtn') { e.preventDefault(); hideAllModals(); showModal('register'); }
            if (target.id === 'switchToLoginBtn') { e.preventDefault(); hideAllModals(); showModal('login'); }
            if (target.closest('.close-modal-btn') || target.classList.contains('modal-backdrop')) hideAllModals();
            if (target.closest('#mobileMenuButton')) document.getElementById('mobile-menu').classList.toggle('hidden');
            if (target.closest('#userButton')) { const dropdown = document.getElementById('userDropdown'); dropdown.classList.toggle('hidden'); setTimeout(() => dropdown.classList.toggle('opacity-0'), 10); setTimeout(() => dropdown.classList.toggle('scale-95'), 10); }
            if (target.closest('#notificationsBtn')) handleNotifications();
            const btn = target.closest('button'); if (!btn) return;
            if (btn.classList.contains('view-details-btn')) { if (btn.dataset.tripId) handleRequestRide(btn.dataset.tripId); else if (btn.dataset.requestId) handleViewDetails(btn.dataset.requestId); }
            if (btn.classList.contains('manage-ride-btn')) handleManageRide(btn.dataset.tripId); if (btn.classList.contains('accept-request-btn')) handleRequestStatusUpdate(btn.dataset.requestId, 'accepted'); if (btn.classList.contains('decline-request-btn')) handleRequestStatusUpdate(btn.dataset.requestId, 'declined'); if (btn.classList.contains('start-trip-btn')) handleTripStatusUpdate(btn.dataset.tripId, 'start'); if (btn.classList.contains('complete-trip-btn')) handleTripStatusUpdate(btn.dataset.tripId, 'complete'); if (btn.classList.contains('chat-btn')) openChat(btn.dataset.requestId);
            if (suggestionItem) { const input = suggestionItem.parentElement.previousElementSibling; input.value = suggestionItem.dataset.value; suggestionItem.parentElement.classList.remove('visible'); }
        });
        document.body.addEventListener('input', e => { if (e.target.classList.contains('location-input')) handleLocationInput(e); });
    }

    function initialize() {
        setupTheme();
        setupEventListeners();
        updateUIForAuthState();
    }
    
    initialize();
});
</script>
</body>
</html>
